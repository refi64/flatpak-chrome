# app-id: com.google.Chrome
app-id: com.google.Chrome.test
desktop-file-name-prefix: '(Testing) '
runtime: org.freedesktop.Platform
runtime-version: '18.08'
sdk: org.freedesktop.Sdk
rename-desktop-file: google-chrome.desktop
rename-appdata-file: google-chrome
rename-icon: google-chrome
finish-args:
  - '--device=dri'
  - '--share=ipc'
  - '--share=network'
  - '--socket=pulseaudio'
  - '--socket=x11'
  - '--socket=wayland'
  - '--env=LD_PRELOAD=/app/lib/fake-sandbox-preload.so'
  - '--filesystem=home'
build-options:
  no-debuginfo: true  # XXX
modules:
  - shared-modules/udev/udev-175.json
  - name: chrome
    buildsystem: simple
    build-commands:
      - 'ar x chrome.deb'
      - 'tar xvf data.tar.xz'
      - 'cp -r opt/google/chrome /app/chrome'
      - 'mkdir -p /app/{bin,share}'
      - 'cp -r usr/share/{appdata,applications} /app/share'
      - 'ln -s /app/chrome/google-chrome /app/bin'
      - |
          for icon in 16 22 24 32 48 64 128 256; do
            dir=/app/share/icons/hicolor/${icon}x${icon}/apps
            mkdir -p $dir
            cp /app/chrome/product_logo_$icon.png $dir/google-chrome.png
          done
      - 'rm /app/chrome/chrome-sandbox'
    sources:
      - type: file
        # https://dl.google.com/linux/chrome/deb/dists/stable/main/binary-amd64/Packages
        url: https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_72.0.3626.119-1_amd64.deb
        sha256: 4513f80f2e858b85d321cd10f7a7cddb3a3aa9f6ac4e903dc0d52493337e3a13
        dest-filename: chrome.deb
  - name: fake-sandbox
    buildsystem: simple
    build-commands:
      - 'gcc -g -O2 -fPIC -shared -o /app/lib/fake-sandbox-preload.so fake-sandbox-preload.c -ldl'
      - 'gcc -g -O2 -o /app/chrome/chrome-sandbox fake-sandbox.c `pkg-config --cflags --libs glib-2.0 gio-2.0`'
    sources:
      - type: file
        path: fake-sandbox-preload.c
      - type: file
        path: fake-sandbox.c
